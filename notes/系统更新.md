> 放丢失，来自： [解决 Windows 11 更新「某些操作未按计划进行」问题](https://zhuanlan.zhihu.com/p/687533602?utm_psn=1792716959315533824)

# Windows11 系统更新「某些操作未按计划进行」

## 问题的诱因
不清楚更新失败的原因，但推测，更新故障和系统关键组件出现损坏有关。因为的确在运行 `SFC` 和 `DISM` 的时候，它们均给出了系统文件有损坏的报告。

不过也有可能是 `Windows Update` 服务未正常运行、更新缓存损坏或残留等复杂的原因导致的。以下解决方案应当被视作是这种问题的一类通解，因为它涉及到清除更新缓存、修复系统组件等一系列操作，大概率能够解决各种可能的问题。

## ① 重启服务，清除残留

解决方案是重置 `Windows Update` 服务的状态、清除残留，以及修复系统可能损坏的文件。接下来的步骤使用具有管理员权限的 `cmd` 操作。

### 设置与更新相关的服务的运行状态
这一步是确保与更新相关的组件处于正常的运行状态（自动运行）。

```powershell
sc config wuauserv start=auto
sc config bits start=auto
sc config cryptsvc start=auto
sc config trustedinstaller start=auto
sc config wuauserv type=share
```

### 停止与更新相关的服务
我们需要在后续清除更新缓存，所以解除其对应的占用是关键的。我们需要先停止与更新相关的所有服务。如果提示对应的服务没有启用，忽略该提示而继续进行下一行。

```powershell
net stop wuauserv
net stop cryptsvc
net stop bits
net stop msiserver
```

### 重置更新的临时文件
这一步清除了 `Windows Update` `的临时文件和签名目录。Windows` 会在服务重新启用后重新创建这些文件。不过，为了防止潜在的问题，我们采取重命名文件`（.bak）`的方法。如果系统提示找不到指定的文件，忽略该提示而继续进行下一行。如果系统提示文件被占用，请重做上一步（停止与更新相关的服务）操作，并且尽可能快得做完上一步和这一步（否则服务会在这一步之前被启用）。如果始终无法重命名这两个文件夹，请跳过此步而做下一步（启用与更新相关的服务）。

```powershell
ren C:\Windows\SoftwareDistribution SoftwareDistribution.old
ren C:\Windows\System32\catroot2 catroot2.old
```

### 启用与更新相关的服务
这一步启用与更新相关的服务。服务会自动创建上一步被重命名的两个文件夹。

```powershell
net start wuauserv
net start cryptsvc
net start bits
net start msiserver
```

### 用 `SFC` 扫描系统组件的问题
`SFC` 全称「系统文件检查器」，这里我们用它检测受保护的系统文件是否损坏。如果损坏，它会自动用缓存文件夹中对应文件的正确版本替换损坏的文件。

如果在做这一步时遇到问题，提示有已挂起的系统修复（我没记清具体的提示），需要重启后继续操作，则重启后从这一步重做。如果 `SFC` 提示有系统组件出现错误，则说明系统文件的确有损坏的，忽略该提示并继续下述操作。

```powershell
sfc /scannow
```

### 用 `DISM` 扫描和修复组件
在这一步中，`DISM` 会清除旧的组件，检查系统组件的损坏，判定损坏的状态并且从 `Windows` 更新中获取干净的组件文件来修复。

```powershell
dism /online /Cleanup-Image /StartComponentCleanup
dism /online /Cleanup-Image /ScanHealth
dism /online /Cleanup-Image /CheckHealth
dism /online /Cleanup-Image /RestoreHealth
```

请注意，这一步操作需要互联网连接。你也可以将已有的 Windows 镜像作为恢复源，在这里我们不讲解这种操作。

在 `RestoreHealth` 过程中，可能会在 `62.3%` 处卡住一小会。请耐心等待。如果出现任何报错，重新这一步操作。

### 重新启动并更新
现在，Windows 损坏的组件应当已经被检查和修复了。重新启动后再一次拉取更新，应当可以看到问题被解决了。


## ② 使用 MediaCreationTool 镜像更新

[使用MediaCreationToolW11升级/修复Windows11系统](https://answers.microsoft.com/zh-hans/windows/forum/windows_11-wintop_update/%e4%bd%bf%e7%94%a8mediacreationtoolw11%e5%8d%87/dcf5f197-d41a-4ccb-8d12-3cf104572f89)

## ③ 重建引导
本人尝试镜像更新后失败，在 `CSDN` 上看到一个哥们重建引导成功，猜想可能是引导不规范导致的。

1. 使用 `DiskGenius` 查看系统盘是否有 `ESP` 分区
2. 若没有，确保分出 `300MB` 空闲分区，右键系统盘 `新建 ESP/MSR 分区`
3. 再使用 `Dism++` 引导修复，刷新 `DiskGenius` 查看 `ESP` 中是否有 `EFI` 文件夹
4. 若没有，再使用 `NTBootAutofix` 自动修复，刷新 `DiskGenius` 查看 `ESP` 中是否有 `EFI` 文件夹

> ps: 非相邻分区合并可使用 傲梅分区助手 挪区，2T 盘大概需要半小时